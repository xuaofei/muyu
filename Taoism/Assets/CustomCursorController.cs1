using UnityEngine;
using UnityEngine.UI;

/// <summary>
/// Hides the native cursor and drives a UI Image so the pointer can be skinned.
/// Attach this to the Image that should behave like the cursor and assign sprites in the inspector.
/// </summary>
// [RequireComponent(typeof(Image))]
public class CustomCursorController : MonoBehaviour
{
    public static CustomCursorController Instance { get; private set; }
    [Header("Sprites")]
    [SerializeField] private Sprite defaultSprite;
    [SerializeField] private Sprite pressedSprite;

    [Header("Optional Settings")]
    [SerializeField] private Vector2 hotspot = Vector2.zero;
    [SerializeField] private bool lockCursorToWindow = false;

    public Texture2D normalCursor;
    public Texture2D tapCursor;

    public Texture2D currentNormalCursor;
    public Texture2D currentTapCursor;
    public Image cursorUpImage;
    public Image cursorDownImage;
    private RectTransform cursorUpRect;
    private RectTransform cursorDownRect;

    

    private int cursorUpWidth;
    private int cursorUpHeight;
    private int cursorDownWidth;
    private int cursorDownHeight;
    Vector2 normalHotspot;
    Vector2 tapHotspot;

    private void Awake()
    {
        // cursorUpImage = GetComponent<Image>();
        if (cursorUpImage)
        {
            Debug.Log("xaflog cursorUpImage");
        }

        // cursorUpImage.position = rectTransform.position;
        cursorUpRect = cursorUpImage.rectTransform;
        cursorDownRect = cursorDownImage.rectTransform;

        cursorDownImage.enabled = false;

        OnEnable();

        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject); // 可选：跨场景不销毁
        }
        else
        {
            Destroy(gameObject);
        }
    }

    private void OnEnable()
    {
        // Cursor.visible = false;
        // Cursor.lockState = lockCursorToWindow ? CursorLockMode.Confined : CursorLockMode.None;

        if (defaultSprite != null)
        {
            // cursorUpImage.sprite = defaultSprite;
            // Debug.Log("xaflog defaultSprite");
        }
    }

    private void OnDisable()
    {
        Cursor.visible = true;
        // Cursor.lockState = CursorLockMode.None;
    }

    private void Update()
    {
        Vector3 mousePosition = Input.mousePosition;
        Vector3 upSpace = new Vector3(-defaultSprite.rect.width*0.2f, 0, 0);
        Vector3 downSpace = new Vector3(-defaultSprite.rect.width*0.2f, -pressedSprite.rect.height*0.28f, 0);
        cursorUpRect.position = mousePosition + (Vector3)hotspot + upSpace;
        cursorDownRect.position = mousePosition + (Vector3)hotspot + downSpace;

        // Debug.Log("xaflog cursorUpRect.position x:" + cursorUpRect.position.x);
        // Debug.Log("xaflog cursorUpRect.position y:" + cursorUpRect.position.y);
        // Debug.Log("xaflog cursorUpRect.position z:"+ cursorUpRect.position.z);

        // if (pressedSprite == null || defaultSprite == null)
        // {
        //     return;
        // }
        // // return;
        // bool isPressed = Input.GetMouseButton(0);
        // cursorUpImage.sprite = isPressed ? pressedSprite : defaultSprite;
    }

    public void OnCursorUp()
    {
        cursorUpImage.enabled = true;
        cursorDownImage.enabled = false;

        // cursorUpImage.sprite = defaultSprite;
        // cursorUpImage.rectTransform.sizeDelta = new Vector2(defaultSprite.texture.width, defaultSprite.texture.height);
        Debug.Log("xaflog OnCursorUp");

        Debug.Log($"xaflog 整个纹理的尺寸: {defaultSprite.texture.width} x {defaultSprite.texture.height}");
        Debug.Log($"xaflog Sprite自身的像素尺寸: {defaultSprite.rect.width} x {defaultSprite.rect.height}");
    }

    public void OnCursorDown()
    {
        cursorUpImage.enabled = false;
        cursorDownImage.enabled = true;


        // cursorDownImage.sprite = pressedSprite;
        // cursorDownImage.rectTransform.sizeDelta = new Vector2(pressedSprite.texture.width, pressedSprite.texture.height);
        // cursorUpImage.rectTransform.position = mousePosition + (Vector3)hotspot;
        Debug.Log("xaflog OnCursorDown");

        Debug.Log($"xaflog 整个纹理的尺寸: {pressedSprite.texture.width} x {pressedSprite.texture.height}");
        Debug.Log($"xaflog Sprite自身的像素尺寸: {pressedSprite.rect.width} x {pressedSprite.rect.height}");
    }

    public void changeCursorSize(int width)
    {

        Debug.Log("xaflog CustomCursorController changeCursorSize Screen.width：" + width);
        if (width == 500)
        {
            cursorUpWidth = 9;
            cursorUpHeight = 34;
            cursorDownWidth = 7;
            cursorDownHeight = 38;

        }
        else if (width == 700)
        {
            cursorUpWidth = 13;
            cursorUpHeight = 48;
            cursorDownWidth = 10;
            cursorDownHeight = 56;
            Debug.Log("Screen.width == 350");
        }
        else if (width == 900)
        {
            cursorUpWidth = 16;
            cursorUpHeight = 62;
            cursorDownWidth = 13;
            cursorDownHeight = 72;
            Debug.Log("Screen.width == 450");
        }


        cursorUpWidth = (int)(cursorUpWidth * 2);
        cursorUpHeight = (int)(cursorUpHeight * 2);
        cursorDownWidth = cursorDownWidth *2;
        cursorDownHeight = cursorDownHeight *2;

        currentNormalCursor = ScaleTextureGPU(normalCursor, cursorUpWidth, cursorUpHeight);
        currentTapCursor = ScaleTextureGPU(tapCursor, cursorDownWidth, cursorDownHeight);

        normalHotspot = new Vector2(cursorUpWidth / 2, cursorUpHeight / 2);
        tapHotspot = new Vector2(cursorDownWidth / 2, cursorDownHeight / 4);

        Debug.Log("xaflog Start cursorUpWidth: " + cursorUpWidth);
        Debug.Log("xaflog Start cursorUpHeight: " + cursorUpHeight);
        Debug.Log("xaflog Start cursorDownWidth: " + cursorDownWidth);
        Debug.Log("xaflog Start cursorDownHeight: " + cursorDownHeight);

        // 假设 yourTexture2D 是你的 Texture2D 对象
        defaultSprite = Sprite.Create(currentNormalCursor,
                                new Rect(0, 0, currentNormalCursor.width, currentNormalCursor.height),
                                new Vector2(0.5f, 0.5f)); // 轴心点设为精灵中心

        int diff = (int)(currentTapCursor.height * 0.2f);
        diff = 0;
        pressedSprite = Sprite.Create(currentTapCursor,
            new Rect(0, diff, currentTapCursor.width, currentTapCursor.height - diff),
            new Vector2(0.5f, 0.5f)); // 轴心点设为精灵中心


        cursorUpImage.sprite = defaultSprite;
        cursorUpImage.rectTransform.sizeDelta = new Vector2(defaultSprite.texture.width, defaultSprite.texture.height);
        // cursorUpImage.sprite = newNormalCursor;


        cursorDownImage.sprite = pressedSprite;
        cursorDownImage.rectTransform.sizeDelta = new Vector2(pressedSprite.texture.width, pressedSprite.texture.height);
    }
    

    public static Texture2D ScaleTextureGPU(Texture2D sourceTexture, int scaledWidth, int scaledHeight)
    {
        // 创建临时RenderTexture
        RenderTexture renderTexture = RenderTexture.GetTemporary(scaledWidth, scaledHeight, 0);
        // 设置当前活动的RenderTexture
        RenderTexture.active = renderTexture;
        // 使用Graphics.Blit将源纹理拷贝到RenderTexture，并进行缩放
        Graphics.Blit(sourceTexture, renderTexture);

        // 创建新的Texture2D来接收结果
        Texture2D scaledTexture = new Texture2D(scaledWidth, scaledHeight);
        // 从RenderTexture中读取像素
        scaledTexture.ReadPixels(new Rect(0, 0, scaledWidth, scaledHeight), 0, 0);
        scaledTexture.Apply();

        // 清理状态，释放临时RenderTexture
        RenderTexture.active = null;
        RenderTexture.ReleaseTemporary(renderTexture);

        return scaledTexture;
    }
}
